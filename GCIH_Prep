Eradication
- Undoing the threat actor's actions
  - Containment is about stopping their operations
  - Eradication is about removing them
- Examples activities
  - Resotring systems from trusted backups
  - Removing threat actor processes, accounts
  - Performing a vulnerability assessment
- May also help meet goals such as recovery
  - Dealing with fraudulent transactions
  - Modified source code

Recovery
- Business needs to get back up and running
- Rebuilding a system is often the most cost effective
  - Not always possible
  - May consider shorter-term containment options as a band-aid to buy time
- Try to bring systems online during off-hours
  - Easier to monitor
  - This is a business decision... so you may be overruled

Remediation
- Try to identify and fix the root cause
- Compromise due to a weak password
  - Why was the weak password allowed? 
  - Can be difficult if multiple factors involved
- Closely monitor any compromised systems
  - A rootkit and/or backdoor suggests intent to return  
  - Monitor network sensors, host, and application logs
  - Look for incident-specific IOCs

Post-Incident
- Develop a final report (Tailor to your audience)
- Right after an incident, there is a lot of momentum
  - The impact fades over-time
- Schedule a follow-up review
  - What has been implemented?
  - Has the organization been compromised again? Original compromise?
  - Timeframe varies, but 30, 60, and 90-day increments are not uncommon

---------------------------------------------------------------------------------------
Useful PowerShell Commands for IR -
- Get-Process
- Get-Process 'powersh*'
- Get-Process 'powershell' | Select-Object *
- Get-Process -ComputerName SEC504STUDENT
- Get-CimInstance
- Get-CimInstance -Class Win32_process | Select-Object -Property Name,ParentProcessId,ProcessId,CommandLine

- Get-NetTCPConnection
  - Get-NetTCPConnection -State Listen | Select-Object -Property LocalAddress,LocalPort,OwningProcess

- Get-ItemProperty
- Get-ChildItem
  - Get-ItemProperty

- Get-PSDrive

- Get-LocalUser
- Get-LocalGroup
- Get-LocalGroupMember

- Get-ScheduledTask
- Export-ScheduledTask
- Get-ScheduledTaskInfo

- Get-WinEvent

- Compare-Object
- Select-Object
- Out-File

Get-LocalUser | Select-Object -ExpandProperty Name > users-baseline.txt
get-content on users; add user
Get-LocalUser | Select-Object -ExpandProperty Name > users-current.txt
$baseline = Get-Content .\users-baseline.txt
$current = Get-Content .\users-current.txt
Compare-Object $baseline $current

-Memory investigation steps are similar to live investigation steps
	- We use Volatility to analyze memory instead of PowerShell cmdlets
• The analysis process starts with the EOl
	- Suspicious process? Start with PsList and Ps Tree
	- Suspicious network listener? Start with NetScan, then move to processes
	- Suspicious program? Start with CmdLine, then processes
• Get in the habit of documenting your analysis process
	- Retain the results of Volatility plugin analysis by redirecting the output to a file
	- Add - g to suppress the Volatility progress indicator

- How do you know if an unknown program is evil?
	- Suspicious isn't necessarily malicious
	- Oddly named executables aren't enough, might still be benign
• How can you determine indicators?
	- Someone might have reverse engineered it already
	- But not always ... and sometimes signatures change
• Malware investigations can also feed threat intelligence
• Two basic approaches
	- Monitoring the environment: behavioral analysis
	- Examining code: static analysis

- Online engine that performs various types of automated analysis
• VirusTotal will run a specimen through several antivirus engines
	- Can purchase access to uploaded specimens
• Hybrid Analysis has sandboxes that run malware and record activity
	- Can choose if sample should be shared with community
	- Offers a commercial onsite product

- Minimize attack surface for the malware
Storm Center
• Never investigate malware on your day-to-day host... ever
	- An air-gapped system that you wipe after each use is ideal
• More common to use a VM
	- Use host-only (or equivalent) networking
	- Enable firewalls and other measures on the host
• Options for transferring data
	- USB devices
	- Temporarily-enabled virtual machine folders

Get-FileHash <file> - Calculate the SHA256 hash of a file on Windows

Monitoring the environment is a common strategy for investigating malware
• Basic strategy:
	- Get environment ready
	- Take a VM snapshot (if applicable)
	- Enable monitoring tools
	- Run malware
	- Interact with malware (optional)
	- Kill malware (optional)
	- Pause monitoring tools
	- Review output

Often requires some knowledge of the target language
	- Even a little understanding goes a long way
• IDA Pro is the most well-known tool in this area
	- Both disassembler and debugger
	- Optional decompiler (Hex-Rays)
	- Commercial
• Ghidra by NSA
	- Released as an open-source tool
	- Has support for collaboration
• Check out FOR610, SEC660 and SEC760 for more

LLM: a type of Al that uses a large data set of knowledge made
accessible through Natural Language
Processing (NLP)
• Generative Al: A type of Al that generates new content from an LLM
• GPT: Generative Pre-training
Transformer (GPT) is a breakthrough
NLP platform from OpenAl.com
	- Many details are not publicly available
	- Available on an experimental basis with subscriber options; limited API access

Problems with AI:
	- When they are wrong, they are confidently wrong
	- "Hallucinations"; hard time differentiating between creative and factual output

 • Influencing ChatGPT's output can improve the value of the results
	- Limit your output to no more than 300 words
	- Use vocabulary appropriate for a 10th grade reading level
	- Focus the results to recommendations for a manufacturing organization
	- Make the response appropriate for a non-technical executive
• You can also train ChatGPT with a sample of your own writing
	- Analyze the writing style sample inside triple quotes and call it My Style

Tips for using ChatGPT
	- Comply with employer rules
	- What is the impact od an OpenAI breach?
	- NOT a replacement for human analysis
	- Practice prompt engineering to refine the results
	- Watch for errors, like hallucinations

• Content is normalized using the nomenclature conventions adopted by ATT&CK
	- This gives you a consistent framework to work from when describing, documenting, and discussing attacker tactics, techniques, and procedures
• Cross-reference tools and techniques with ATT&CK identifiers
	- "Let's talk about password spray attacks" (Credential Access: TA0006)
	- "Donut injects shellcode into existing assemblies and payloads" (Process Injection:
T1055)
• Validation for attack tool and defense realism

- An attacker may start with a single domain name as a target
- What else can they discover for targets to attack
	- Subdomains
	- Partner and Subsidiary Organizations 
	- Non-production systems

	DNS Zone Transfer
- DNS servers may respond to zone transfer requests
	- Intended for replication from primary DNS to backup DNS servers
	- Uncommonly found on public DNS servers, more likely on internal DNS
	- Zone transfers should only be done in the internal network

	Certificate Transparency
• Modern browsers detect untrusted website certificates
• Modern browsers do not do well detecting malicious certs issued by trusted CAs
• Certificate transparency requires CAs to publish certificate issuance logs
	- Open to scrutiny to look for suspicious certs
• Gather information about targets, which CAs are in use, when certs are renewed, and more

• Subfinder automates subdomain and host enumeration
	- Using several online sources
	- Some sources require registration and/or commercial subscriptions
• Simplifies discovery, but does not replace manual assessment

	Defenses against DNS enumeration
- Do not allow zone transfers from just any system
- Use Split DNS
	- Only include external name information in external DNS servers
- Inspect DNS server logs
	- Look for failed and successful zone transfers
	- Large number of requests from a single source (DNS brute)
	- Use attacking IP to inform threat intelligence efforts
- Use common sources of target enumeration as part of a Cyber Threat Intelligence Program

• Browse the site to collect information about files, resources
	- Look for email addresses, location(s), partner organizations, PDFs, Office documents, images, etc.
	- Use built-in search for discovery
• Use the browser console to gather link information
	- Network data
	- JavaScript Console

• CeWL: Custom Wordlist Generator by Robin Wood
• CeWL crawls a target website and collect all web pages and common document formats (MS Office, PDF, images)
	- Extracts content, metadata, and other strings to one or more files
	- Useful to build wordlist from a target site's content and metadata for later attacks (password attacks, host enumeration, and more)

Have I been Pwned can be used to look up emails you find and see if their credentials were associated with any breaches (this is cool!)

• Limit and control information
	- Know what information is given away and perform risk analysis
• Use offensive tools defensively
	- Most effective when implemented programmatically as part of CTI
• Limit data indexed by search engines using robots.txt
	- Be careful not to point attackers to your sensitive data

Cloud Scanning Process
	- Using reconnaissance, attacker indentifies likely cloud provider
		- DNS information, linked resources in website pages
		- Builtwith.com summarizes service providers for a given site
	- Attacker identifies IP range for provider, performs full scan
	- Leverages scan results to identify other systems for target discovery

Scanning Large Ranges - Masscan
	- Nmap is not ideal to scan millions of IP
	- Masscan separates the SYN send from the ACK receive code
		- Sender can fire-and-forget
		- Receiver identifies open/closed from response
		- By decoupling the two halves of the three-way handshake, speed is greatly improved
		- May send packets too fast for either network to handle
	- Masscan reveals a list of IP addresses listening on TCP/443
	- We can connect to the service and retrieve the certificate details
		- Reveals the certificate common name attribute 

EyeWitness
	- Will take screenshots of websites, VNC and RDP services
	- Can be very effective to sort through hundreds of websites

Cloud Scanning Defense
	- Most targets will not log half-open SYN scans
	- Many web servers will not log TLS-Scan access
	- As defenders we're interested in what happens after scanning
		- Web server logs reveal site crawling
		- Malformed requests or parameters to server-side code

SMB Security
	- SMB is an application layer protocol that implements file and printer sharing, authentication, remote admin, and other features
	- Why is SMB such a problem for modern networks
		- Configuration is often done by end-users (creating shares, choosing files to place on shares, defining security for file access controls
		- It is complex and has lots of legacy functionality to support
SMB Shares
	- Get-CimInstance -Class win32_share -ComputerName <ip> (Works for systems implementing CIM (Mostly Windows))
	- net.exe view \\<ip> /all (Works Windows AND non-Windows sytems)

Searching for SMB Shares - SMBeagle
	- smbeagle -c results.csv -n <ip>/cidr -u <user> -p <password> 

SMB Exploits
	- SMB is a complex protocol that has been around for a long time
	- Organizations mitigate these with regular patching

Identifying and Dropping SMB Sessions
	- Get-SmbSession
	- Get-SmbSession | Select-Object ClientComputerName, Dialect, SecondsExists, SecondsIdle
	- $Password = Read-Host -AsSecureString
	- Set-LocalUser -Name sec504 -Password $Password
	- Close-SmbSession -ClientComputerName 10.10.75.1 -Force

Preparation - Defenses Against Evil SMB Sessions
	- Block access to the following ports across network boundaries and local firewalls
		- TCP/445, UDP/445 TCP/135, TCP/137, UDP/138, TCP/139
		- In general, block all ports except those required
	- Alternative - explicitly permit these ports only from systems or networks that require SMB access to a specified destination
		- File servers and domain controllers
	- Private VLANs are useful to limit inter-workstation access
	- Check for access to the ports listed above in logs

Defense Spotlight - Hayabusa and Sigma Rules
	- Sigma is a signature format for describing threats from log data
		- Widely used by SIEM platforms
		- Sigma is for logging data what Snort is for network and YARA is for files
	- Hayabusa reads Windows event logs and applies Sigma rules for threat detection and timeline generation

About Hayabusa
	- Hayabusa reads from Windows event logs to identify threats and generate an event timeline
	- Uses both Hayabusa rules and imported Sigma rules for threat detection
	- Run on a standalone system or as part of the Velociraptor endpoint monitoring platform
		- Generates CSV, JSON output for integration with other tools
		- Fast command-line interface to search Windows event log data
		- Read data from a running system or saved event logs
Updating Hayabusa Rules
	- ./hayabusa.exe update-rules

How to leverage Hayabusa + Sigma Rules
	- Breadth of detection with Hayabusa + Sigma - fast assessment for thousands of IOC rules
	- Timeline generation and analysis - Investigate patterns across multiple systems by interrogating collective event log data
	- Review data in spreadsheet or Timeline Explorer
	- Consider integrating Hayabusa output with other tools - SIEM, Elasticsearch, Neo4j graphs, etc.
	- Leverage other Hayabusa commands for JSON output, searching


